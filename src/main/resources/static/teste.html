<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Painel de Teste Fiscal WebSocket</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.5.1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; background-color: #f0f2f5; }
        .container { width: 95%; max-width: 1400px; }
        .panel { border: 1px solid #ccc; padding: 20px; margin-top: 20px; border-radius: 8px; background-color: white; }
        h2, h3 { border-bottom: 2px solid #eee; padding-bottom: 10px; color: #333; }
        label { display: block; margin-top: 15px; font-weight: bold; }
        input, select, textarea { width: 100%; padding: 10px; margin-top: 5px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 4px; }
        button { padding: 12px 20px; margin-top: 20px; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 5px; font-size: 16px; }
        button:disabled { background-color: #aaa; cursor: not-allowed; }
        #log { width: 100%; height: 400px; white-space: pre-wrap; background-color: #2b2b2b; color: #f1f1f1; border: 1px solid #444; margin-top: 10px; font-family: monospace; }
        .status-badge { padding: 5px 10px; border-radius: 12px; color: white; font-weight: bold; }
        .status-connected { background-color: #28a745; }
        .status-disconnected { background-color: #dc3545; }
        #operationsPanel[disabled] { opacity: 0.5; pointer-events: none; }
    </style>
</head>
<body>
    <div class="container">
        <h2>Painel de Teste - Middleware Fiscal</h2>

        <div class="panel">
            <h3>1. Conexão e Contexto</h3>
            <button id="connectBtn">Conectar</button>
            <span id="connectionStatus" class="status-badge status-disconnected">Desconectado</span>
            
            <label for="emitenteSelect">Selecionar Emitente:</label>
            <select id="emitenteSelect" disabled>
                <option value="">Selecione um emitente...</option>
            </select>
        </div>

        <div class="panel">
            <h3>2. Cadastrar Novo Emitente</h3>
            <form id="registerForm">
                <label for="reg-uf">UF:</label>
                <select id="reg-uf" required>
                    <option value="MT">Mato Grosso (MT)</option>
                    <option value="RS">Rio Grande do Sul (RS)</option>
                    <option value="SP">São Paulo (SP)</option>
                    <option value="PR">Paraná (PR)</option>
                </select>

                <label for="reg-tipo">Tipo de Certificado:</label>
                <select id="reg-tipo" required>
                    <option value="A1">Certificado A1 (Arquivo)</option>
                </select>

                <label for="certFile">Arquivo do Certificado (.pfx, .p12):</label>
                <input type="file" id="certFile" accept=".pfx,.p12" required>

                <label for="reg-cert-pass">Senha do Certificado:</label>
                <input type="password" id="reg-cert-pass" value="12345" required>

                <button type="submit">Gravar Emitente</button>
            </form>
        </div>

        <div id="operationsPanel" class="panel" disabled>
            <h3>3. Operações</h3>
            <button id="statusServicoBtn">Consultar Status Serviço ({UF})</button>
        </div>

        <div class="panel">
            <h3>Logs da Comunicação</h3>
            <textarea id="log" readonly></textarea>
        </div>
    </div>

<script>
    const connectBtn = document.getElementById('connectBtn');
    const connectionStatus = document.getElementById('connectionStatus');
    const emitenteSelect = document.getElementById('emitenteSelect');
    const registerForm = document.getElementById('registerForm');
    const operationsPanel = document.getElementById('operationsPanel');
    const statusServicoBtn = document.getElementById('statusServicoBtn');
    const logArea = document.getElementById('log');

    let stompClient = null;
    let emitentes = [];

    const UF_CODES = {
        'MT': '51', 'RS': '43', 'SP': '35', 'PR': '41'
    };

    function log(message) {
        logArea.value += `[${new Date().toLocaleTimeString()}] ${message}\n`;
        logArea.scrollTop = logArea.scrollHeight;
    }

    function setConnectionStatus(connected) {
        connectBtn.disabled = connected;
        connectionStatus.textContent = connected ? 'Conectado' : 'Desconectado';
        connectionStatus.className = `status-badge ${connected ? 'status-connected' : 'status-disconnected'}`;
        emitenteSelect.disabled = !connected;
    }

    function updateOperationsPanel(selectedEmitente) {
        if (selectedEmitente) {
            operationsPanel.removeAttribute('disabled');
            statusServicoBtn.textContent = `Consultar Status Serviço (${selectedEmitente.uf})`;
        } else {
            operationsPanel.setAttribute('disabled', 'true');
            statusServicoBtn.textContent = 'Consultar Status Serviço ({UF})';
        }
    }

    function populateEmitenteSelect(emitenteList) {
        emitentes = emitenteList;
        emitenteSelect.innerHTML = '<option value="">Selecione um emitente...</option>';
        emitentes.forEach(e => {
            const option = document.createElement('option');
            option.value = e.cnpj;
            option.textContent = `${e.razaoSocial} (${e.cnpj}) - ${e.uf}`;
            emitenteSelect.appendChild(option);
        });

        const savedCnpj = localStorage.getItem('selectedCnpj');
        if (savedCnpj) {
            emitenteSelect.value = savedCnpj;
            const selected = emitentes.find(e => e.cnpj === savedCnpj);
            updateOperationsPanel(selected);
        }
    }

    function requestEmitenteList() {
        if (!stompClient || !stompClient.connected) return;
        log('Solicitando lista de emitentes...');
        stompClient.send('/app/transmitir', {}, JSON.stringify({ action: 'list_emitentes' }));
    }
    
    connectBtn.addEventListener('click', () => {
        log('Tentando conectar ao WebSocket...');
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, (frame) => {
            log('Conexão WebSocket estabelecida: ' + frame);
            setConnectionStatus(true);
            requestEmitenteList();

            stompClient.subscribe('/topic/responses', (response) => {
                const parsedResponse = JSON.parse(response.body);
                log(`RESPOSTA RECEBIDA (${parsedResponse.originalAction}):\n` + JSON.stringify(parsedResponse, null, 2));
                
                switch(parsedResponse.originalAction) {
                    case 'list_emitentes':
                        populateEmitenteSelect(parsedResponse.body);
                        break;
                    case 'register':
                        if(parsedResponse.status === 200) {
                            alert('Emitente cadastrado com sucesso!');
                            requestEmitenteList(); // Recarrega a lista
                        } else {
                            alert('Erro no cadastro: ' + parsedResponse.message);
                        }
                        break;
                    case 'transmit':
                        // A resposta já foi logada, nada mais a fazer aqui por enquanto.
                        break;
                }
            });
        }, (error) => {
            log('Erro de conexão WebSocket: ' + error);
            setConnectionStatus(false);
        });
    });

    emitenteSelect.addEventListener('change', () => {
        const selectedCnpj = emitenteSelect.value;
        if (selectedCnpj) {
            localStorage.setItem('selectedCnpj', selectedCnpj);
            const selected = emitentes.find(e => e.cnpj === selectedCnpj);
            updateOperationsPanel(selected);
        } else {
            localStorage.removeItem('selectedCnpj');
            updateOperationsPanel(null);
        }
    });

    registerForm.addEventListener('submit', (e) => {
        e.preventDefault();
        if (!stompClient || !stompClient.connected) {
            alert("ERRO: Conecte ao WebSocket primeiro.");
            return;
        }

        const fileInput = document.getElementById('certFile');
        const file = fileInput.files[0];
        if (!file) {
            alert("ERRO: Por favor, selecione um arquivo de certificado.");
            return;
        }

        const reader = new FileReader();
        reader.onload = (event) => {
            const base64String = event.target.result.split(',')[1];
            const payload = {
                action: 'register',
                data: {
                    uf: document.getElementById('reg-uf').value,
                    tipo: document.getElementById('reg-tipo').value,
                    arquivoBase64: base64String,
                    senha: document.getElementById('reg-cert-pass').value
                }
            };
            stompClient.send("/app/transmitir", {}, JSON.stringify(payload));
            log('ENVIADO (Registro Emitente):\n' + JSON.stringify(payload, (key, value) => key === 'arquivoBase64' ? '...' : value, 2));
        };
        reader.onerror = (error) => {
            log("ERRO ao ler o arquivo: " + error);
        };
        reader.readAsDataURL(file);
    });

    statusServicoBtn.addEventListener('click', () => {
        const selectedCnpj = localStorage.getItem('selectedCnpj');
        if (!selectedCnpj) {
            alert('Nenhum emitente selecionado.');
            return;
        }
        
        const emitente = emitentes.find(e => e.cnpj === selectedCnpj);
        const ufCode = UF_CODES[emitente.uf];
        if(!ufCode) {
            alert(`UF ${emitente.uf} não mapeada para código IBGE.`);
            return;
        }

        // Ambiente fixo em Homologação (2)
        const xml = `<consStatServ xmlns="http://www.portalfiscal.inf.br/nfe" versao="4.00"><tpAmb>2</tpAmb><cUF>${ufCode}</cUF><xServ>STATUS</xServ></consStatServ>`;

        const payload = {
            action: 'transmit',
            cnpj: selectedCnpj,
            servico: 'NFeStatusServico4',
            xml: xml
        };
        
        stompClient.send("/app/transmitir", {}, JSON.stringify(payload));
        log('ENVIADO (Consulta Status):\n' + JSON.stringify(payload, null, 2));
    });

    // Initial state
    setConnectionStatus(false);
    updateOperationsPanel(null);
</script>
</body>
</html>
